\begin{figure}
  \input{images/stepped.pgf}
  \caption{Survival plot % TODO{2019-04-15}: NAME OF PLOT
    for running QuickSpec on inputs containing various numbers of definitions,
    sampled from TIP. Most samples finished quickly, leaving a heavy tail which
    didn't finish within the 300 second timeout.}
  \label{fig:survival}
\end{figure}

\begin{figure}
  \input{images/timeouts.pgf}
  \caption{Proportion of samples which timed out per size, with least-squares
    linear regression.}
  \label{fig:tailsize}
\end{figure}

\begin{figure}
  \input{images/proportions.pgf}
  \caption{}
  \label{fig:proportions}
\end{figure}

Five definitions appeared only in failing samples, these are named
\texttt{mul3}, \texttt{mul3acc}, \texttt{mult2}, \texttt{op} and \texttt{qexp};
their definitions appear in Figure~\ref{fig:faildefs}. All of these are
functions of Peano-encoded natural numbers (\texttt{Nat}), and they cause
exploration to time out by generating very large outputs.

\texttt{mul3} and \texttt{mul3acc} are rather pathological implementations of
multiplication with an accumulator parameter, with many (non-tail) recursive
calls. \texttt{mult2} and \texttt{qexp} are standard tail-recursive definitions
of multiplication and exponentiation, respectively. The \texttt{op} function
seems to exist only for testing purposes, appearing in files named
\texttt{weird_nat_op} which assert its commutativity and associativity.

Exploring each of these functions on its own does not require much memory, since
Haskell generates the output lazily. However, comparing such large numbers for
equality takes a lot of CPU time as the \texttt{S} constructors are successively
unwrapped from each side, and this is why the timeout is reached. We confirmed
this hypothesis by exploring with a custom data generator which only generates
the values \texttt{Z}, \texttt{S Z} and \texttt{S (S Z)} (0, 1 and 2); this
caused the exploration to finish quickly. Other interventions, like making the
accumulator arguments strict (to prevent space leaks), did not prevent timeouts.

\begin{figure}
  \texttt{
    (define-fun-rec mult2 ((x Nat) (y Nat) (z Nat)) Nat
      (match x
        (case Z      z)
        (case (S x2) (mult2 x2 y (plus y z)))))
  }

  \texttt{
    (define-fun-rec qexp ((x Nat) (y Nat) (z Nat)) Nat
      (match y
        (case Z     z)
        (case (S n) (qexp x n (mult x z)))))
  }

  \texttt{
    (define-fun-rec op ((x Nat) (y Nat) (z Nat) (x2 Nat)) Nat
      (match x
        (case Z
          (match z
            (case Z      x2)
            (case (S x3) (op Z  y x3 (S x2)))))
        (case (S x4)
          (match z
            (case Z      (op x4 y y  x2))
            (case (S c ) (op x  y c  (S x2)))))))
  }

  \texttt{
    (define-fun-rec mul3acc ((x Nat) (y Nat) (z Nat)) Nat
      (match x
        (case Z Z)                          ;; Base case for 0 * y * z
        (case (S x2)
          (match y
            (case Z Z)                      ;; Base case for x * 0 * z
            (case (S x3)
              (match z
                (case Z Z)                  ;; Base case for x * y * 0
                (case (S x4)
                  (match x2
                    (case Z
                      (match x3
                        (case Z
                          (match x4
                            (case Z (S Z))  ;; Base case for 1 * 1 * 1
                            (case (S x5)
                              (S (add3acc (mul3acc Z Z x4)
                                          (add3acc (mul3acc (S Z) Z x4)
                                                   (mul3acc Z (S Z) x4)
                                                   (mul3acc Z Z (S Z)))
                                          (add3acc Z Z x4))))))
                        (case (S x6)
                          (S (add3acc (mul3acc Z x3 x4)
                                      (add3acc (mul3acc (S Z) x3 x4)
                                               (mul3acc Z (S Z) x4)
                                               (mul3acc Z x3 (S Z)))
                                      (add3acc Z x3 x4))))))
                    (case (S x7)
                      (S (add3acc (mul3acc x2 x3 x4)
                                  (add3acc (mul3acc (S Z) x3 x4)
                                           (mul3acc x2 (S Z) x4)
                                           (mul3acc x2 x3 (S Z)))
                                  (add3acc x2 x3 x4))))))))))))
  }

  \texttt{
    (define-fun-rec mul3 ((x Nat) (y Nat) (z Nat)) Nat
      (match x
        (case Z Z)                          ;; Base case for 0 * y * z
        (case (S x2)
          (match y
            (case Z Z)                      ;; Base case for x * 0 * z
            (case (S x3)
              (match z
                (case Z Z)                  ;; Base case for x * y * 0
                (case (S x4)
                  (match x2
                    (case Z
                      (match x3
                        (case Z
                          (match x4
                            (case Z (S Z))  ;; Base case for 1 * 1 * 1
                            (case (S x5)
                              (S (add3 (mul3 Z Z x4)
                                       (add3 (mul3 (S Z) Z x4)
                                             (mul3 Z (S Z) x4)
                                             (mul3 Z Z (S Z)))
                                       (add3 Z Z x4))))))
                        (case (S x6)
                          (S (add3 (mul3 Z x3 x4)
                                   (add3 (mul3 (S Z) x3 x4)
                                         (mul3 Z (S Z) x4)
                                         (mul3 Z x3 (S Z)))
                                   (add3 Z x3 x4))))))
                    (case (S x7)
                      (S (add3 (mul3 x2 x3 x4)
                               (add3 (mul3 (S Z) x3 x4)
                                     (mul3 x2 (S Z) x4)
                                     (mul3 x2 x3 (S Z)))
                               (add3 x2 x3 x4))))))))))))
  }
  \label{fig:faildefs}
\end{figure}

To assess the impact of these problematic definitions, we removed any samples
containing them and repeated our analysis.
